#!/usr/bin/env bash
set -euo pipefail

# Claude Context ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸
# í†µí•©ëœ êµ¬ì¡°ë¥¼ ìœ„í•œ ì„¤ì¹˜ í”„ë¡œì„¸ìŠ¤

# ìƒ‰ìƒ ì •ì˜
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# ì„¤ì •
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
INSTALL_DIR="${HOME}/.claude/hooks"
CONFIG_FILE="${INSTALL_DIR}/config.sh"
CONFIG_TEMPLATE="${PROJECT_ROOT}/config.sh.template"

# í—¤ë” ì¶œë ¥
print_header() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘     Claude Context ì„¤ì¹˜              â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

# ëª¨ë“œ ì„ íƒ
select_mode() {
    echo -e "${BLUE}ì„¤ì¹˜ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”:${NC}"
    echo
    echo "1) Basic   - CLAUDE.md ì£¼ì…ë§Œ (ê°€ì¥ ê°„ë‹¨)"
    echo "2) History - ëŒ€í™” ê¸°ë¡ ê´€ë¦¬ ì¶”ê°€ (Gemini ë¶ˆí•„ìš”)"
    echo "3) Advanced - í† í° ëª¨ë‹ˆí„°ë§ í¬í•¨ (Gemini í•„ìš”)"
    echo
    read -p "ì„ íƒ [1-3]: " choice
    
    case $choice in
        1) echo "basic" ;;
        2) echo "history" ;;
        3) echo "advanced" ;;
        *) 
            echo -e "${RED}ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.${NC}"
            exit 1
            ;;
    esac
}

# ì˜ì¡´ì„± í™•ì¸
check_dependencies() {
    local mode="$1"
    local missing=()
    
    # ê¸°ë³¸ ì˜ì¡´ì„±
    for cmd in jq sha256sum gzip; do
        if ! command -v "$cmd" &> /dev/null; then
            missing+=("$cmd")
        fi
    done
    
    # Advanced ëª¨ë“œ ì˜ì¡´ì„±
    if [[ "$mode" == "advanced" ]]; then
        if ! command -v gemini &> /dev/null; then
            echo -e "${YELLOW}ê²½ê³ : 'gemini' CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.${NC}"
            echo "Advanced ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ geminiê°€ í•„ìš”í•©ë‹ˆë‹¤."
            echo "https://github.com/google/generative-ai-docs/tree/main/gemini-cli"
            read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? [y/N]: " confirm
            if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
                exit 1
            fi
        fi
    fi
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo -e "${RED}ë‹¤ìŒ ëª…ë ¹ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤: ${missing[*]}${NC}"
        echo "ì„¤ì¹˜ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
        exit 1
    fi
}

# ë°±ì—… ìƒì„±
create_backup() {
    if [[ -d "$INSTALL_DIR" ]]; then
        local backup_dir="${INSTALL_DIR}.backup.$(date +%Y%m%d_%H%M%S)"
        echo "ê¸°ì¡´ ì„¤ì¹˜ë¥¼ ë°±ì—…í•©ë‹ˆë‹¤..."
        cp -r "$INSTALL_DIR" "$backup_dir"
        echo -e "${GREEN}âœ“ ë°±ì—… ì™„ë£Œ: $backup_dir${NC}"
    fi
}

# íŒŒì¼ ì„¤ì¹˜
install_files() {
    echo "íŒŒì¼ì„ ì„¤ì¹˜í•˜ëŠ” ì¤‘..."
    
    # ë””ë ‰í† ë¦¬ ìƒì„±
    mkdir -p "$INSTALL_DIR"/{src/{core,monitor,utils},tests,docs,examples}
    
    # íŒŒì¼ ë³µì‚¬
    cp -r "$PROJECT_ROOT"/src/* "$INSTALL_DIR/src/" 2>/dev/null || true
    cp -r "$PROJECT_ROOT"/tests/* "$INSTALL_DIR/tests/" 2>/dev/null || true
    cp -r "$PROJECT_ROOT"/docs/* "$INSTALL_DIR/docs/" 2>/dev/null || true
    cp -r "$PROJECT_ROOT"/examples/* "$INSTALL_DIR/examples/" 2>/dev/null || true
    cp "$PROJECT_ROOT"/*.md "$INSTALL_DIR/" 2>/dev/null || true
    
    # ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
    find "$INSTALL_DIR" -name "*.sh" -type f -exec chmod +x {} \;
    
    echo -e "${GREEN}âœ“ íŒŒì¼ ì„¤ì¹˜ ì™„ë£Œ${NC}"
}

# ì„¤ì • íŒŒì¼ ìƒì„±
create_config() {
    local mode="$1"
    
    echo "ì„¤ì • íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ì¤‘..."
    
    if [[ -f "$CONFIG_TEMPLATE" ]]; then
        sed "s/{{MODE}}/$mode/g" "$CONFIG_TEMPLATE" > "$CONFIG_FILE"
    else
        # í…œí”Œë¦¿ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì„¤ì • ìƒì„±
        cat > "$CONFIG_FILE" << EOF
#!/usr/bin/env bash
# Claude Context Configuration

CLAUDE_CONTEXT_MODE="$mode"
CLAUDE_ENABLE_CACHE="true"
CLAUDE_INJECT_PROBABILITY="1.0"
CLAUDE_HOME="\${HOME}/.claude"
CLAUDE_HOOKS_DIR="\${CLAUDE_HOME}/hooks"
CLAUDE_HISTORY_DIR="\${CLAUDE_HOME}/history"
CLAUDE_SUMMARY_DIR="\${CLAUDE_HOME}/summaries"
CLAUDE_CACHE_DIR="\${XDG_CACHE_HOME:-\${HOME}/.cache}/claude-context"

export CLAUDE_CONTEXT_MODE
export CLAUDE_ENABLE_CACHE
export CLAUDE_INJECT_PROBABILITY
export CLAUDE_HOME
export CLAUDE_HOOKS_DIR
export CLAUDE_HISTORY_DIR
export CLAUDE_SUMMARY_DIR
export CLAUDE_CACHE_DIR
EOF
    fi
    
    echo -e "${GREEN}âœ“ ì„¤ì • íŒŒì¼ ìƒì„± ì™„ë£Œ${NC}"
}

# Claude ì„¤ì • ì—…ë°ì´íŠ¸
update_claude_config() {
    local claude_config="${HOME}/.claude/settings.json"
    
    if [[ ! -f "$claude_config" ]]; then
        echo -e "${YELLOW}Claude ì„¤ì • íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
        echo "Claude Codeë¥¼ í•œ ë²ˆ ì‹¤í–‰í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
        return
    fi
    
    echo "Claude ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘..."
    
    # ë°±ì—… ìƒì„±
    cp "$claude_config" "${claude_config}.backup.$(date +%Y%m%d_%H%M%S)"
    
    # hooks ì„¤ì • ì—…ë°ì´íŠ¸
    local updated_config=$(jq '. * {
        "hooks": {
            "PreToolUse": "'"${INSTALL_DIR}/src/core/injector.sh"'",
            "PreCompact": "'"${INSTALL_DIR}/src/core/precompact.sh"'"
        }
    }' "$claude_config")
    
    echo "$updated_config" > "$claude_config"
    
    echo -e "${GREEN}âœ“ Claude ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ${NC}"
}

# ë””ë ‰í† ë¦¬ ìƒì„±
create_directories() {
    local mode="$1"
    
    # ê¸°ë³¸ ë””ë ‰í† ë¦¬
    mkdir -p "${HOME}/.claude"
    mkdir -p "${XDG_CACHE_HOME:-${HOME}/.cache}/claude-context"
    
    # History ëª¨ë“œ ë””ë ‰í† ë¦¬
    if [[ "$mode" == "history" || "$mode" == "advanced" ]]; then
        mkdir -p "${HOME}/.claude/history"
        mkdir -p "${HOME}/.claude/summaries"
    fi
}

# ì‚¬ìš©ë²• ì¶œë ¥
print_usage() {
    local mode="$1"
    
    echo
    echo -e "${GREEN}ğŸ‰ ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
    echo
    echo -e "${BLUE}ì„¤ì¹˜ëœ ëª¨ë“œ: $(echo "$mode" | tr '[:lower:]' '[:upper:]')${NC}"
    echo
    echo "ë‹¤ìŒ ë‹¨ê³„:"
    echo "1. CLAUDE.md íŒŒì¼ ìƒì„±:"
    echo "   - ì „ì—­: ~/.claude/CLAUDE.md"
    echo "   - í”„ë¡œì íŠ¸ë³„: <í”„ë¡œì íŠ¸ë£¨íŠ¸>/CLAUDE.md"
    echo
    
    if [[ "$mode" == "history" || "$mode" == "advanced" ]]; then
        echo "2. ëŒ€í™” ê¸°ë¡ ê´€ë¦¬:"
        echo "   ${INSTALL_DIR}/src/monitor/claude_history_manager.sh --help"
        echo
    fi
    
    if [[ "$mode" == "advanced" ]]; then
        echo "3. Gemini API ì„¤ì •:"
        echo "   export GEMINI_API_KEY=<your-api-key>"
        echo
    fi
    
    echo "4. Claude Code ì¬ì‹œì‘"
    echo
    echo "ì„¤ì • ë³€ê²½: ${CONFIG_FILE}"
    echo "ë¬¸ì œ í•´ê²°: ${INSTALL_DIR}/docs/troubleshooting.md"
}

# ì œê±° ì˜µì…˜
uninstall() {
    echo -e "${RED}Claude Contextë¥¼ ì œê±°í•©ë‹ˆë‹¤...${NC}"
    
    # Claude ì„¤ì •ì—ì„œ hooks ì œê±°
    local claude_config="${HOME}/.claude/settings.json"
    if [[ -f "$claude_config" ]]; then
        jq 'del(.hooks)' "$claude_config" > "${claude_config}.tmp"
        mv "${claude_config}.tmp" "$claude_config"
    fi
    
    # ì„¤ì¹˜ ë””ë ‰í† ë¦¬ ì œê±°
    if [[ -d "$INSTALL_DIR" ]]; then
        rm -rf "$INSTALL_DIR"
    fi
    
    echo -e "${GREEN}âœ“ ì œê±°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
    echo "ë°ì´í„° ë””ë ‰í† ë¦¬ëŠ” ë³´ì¡´ë©ë‹ˆë‹¤:"
    echo "- ~/.claude/history"
    echo "- ~/.claude/summaries"
    echo "- ~/.cache/claude-context"
}

# ë©”ì¸ ì‹¤í–‰
main() {
    # ì œê±° ì˜µì…˜ í™•ì¸
    if [[ "${1:-}" == "--uninstall" ]]; then
        uninstall
        exit 0
    fi
    
    print_header
    
    # ëª¨ë“œ ì„ íƒ
    MODE=$(select_mode)
    echo
    echo -e "${BLUE}ì„ íƒí•œ ëª¨ë“œ: $MODE${NC}"
    echo
    
    # ì˜ì¡´ì„± í™•ì¸
    check_dependencies "$MODE"
    
    # ë°±ì—… ìƒì„±
    create_backup
    
    # ì„¤ì¹˜ ì§„í–‰
    install_files
    create_config "$MODE"
    create_directories "$MODE"
    update_claude_config
    
    # ì™„ë£Œ ë©”ì‹œì§€
    print_usage "$MODE"
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main "$@"